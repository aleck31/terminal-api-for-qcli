# Terminal API Demo

åŸºäº TTYD çš„ Web ç»ˆç«¯ API æ¼”ç¤ºé¡¹ç›®

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº TTYD å®ç°çš„ Web ç»ˆç«¯ API æ¼”ç¤ºé¡¹ç›®ï¼Œæ”¯æŒé€šè¿‡ Web ç•Œé¢è®¿é—® Linux ç»ˆç«¯ï¼Œå¹¶å¯ä»¥è¿è¡Œå„ç§äº¤äº’å¼å‘½ä»¤è¡Œç¨‹åºå¦‚: Bashã€Q CLIã€Python ç­‰ã€‚

### ğŸ“ˆ é¡¹ç›®çŠ¶æ€
- âœ… **æ ¸å¿ƒåŠŸèƒ½å®Œæˆ**: TTYDæœåŠ¡é›†æˆã€WebSocketé€šä¿¡ã€æµå¼è¾“å‡ºå¤„ç†
- âœ… **ç°ä»£åŒ–UI**: åŸºäºGradio 5çš„ChatInterfaceç•Œé¢ï¼Œæ”¯æŒMarkdownæ ¼å¼è¾“å‡º
- âœ… **å®‰å…¨é˜²æŠ¤**: å±é™©å‘½ä»¤æ£€æµ‹å’Œæ‹¦æˆªæœºåˆ¶
- âœ… **å®Œæ•´æµ‹è¯•**: é›†æˆæµ‹è¯•å¥—ä»¶ï¼Œç¡®ä¿ç¨³å®šæ€§
- âœ… **ç®€æ´æ¶æ„**: é¿å…è¿‡åº¦å·¥ç¨‹åŒ–ï¼Œä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½
- ğŸš€ **ç”Ÿäº§å°±ç»ª**: å¯ç›´æ¥éƒ¨ç½²ä½¿ç”¨

## ğŸ“ é¡¹ç›®ç»“æ„

```
terminal-api-for-qcli/
â”œâ”€â”€ api/                    # APIç»„ä»¶
â”‚   â”œâ”€â”€ terminal_api_client.py   # ä¸»è¦APIæ¥å£
â”‚   â”œâ”€â”€ websocket_client.py      # WebSocketå®¢æˆ·ç«¯
â”‚   â””â”€â”€ utils/                   # å·¥å…·ç»„ä»¶
â”œâ”€â”€ ttyd/                   # TTYDæœåŠ¡ç®¡ç†
â”‚   â”œâ”€â”€ ttyd-service.sh     # æœåŠ¡ç®¡ç†è„šæœ¬
â”‚   â”œâ”€â”€ conf.ini           # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ pids/               # PIDæ–‡ä»¶ç›®å½•
â”œâ”€â”€ webui/                  # Web UI
â”‚   â””â”€â”€ gradio_chat.py      # Gradio ChatInterface WebUI
â”œâ”€â”€ qcli_interactive_demo.py # Q CLI äº¤äº’æ¼”ç¤ºåº”ç”¨
â”œâ”€â”€ run_tests.py            # æµ‹è¯•è¿è¡Œå™¨
â”œâ”€â”€ tests/                  # æµ‹è¯•å¥—ä»¶
â”œâ”€â”€ logs/                   # æ—¥å¿—ç›®å½•
â”œâ”€â”€ start-webui.sh          # Gradio WebUI å¯åŠ¨è„šæœ¬
â””â”€â”€ README.md
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

é‡‡ç”¨**æ¨¡å—åŒ–åˆ†å±‚æ¶æ„**ï¼ŒèŒè´£æ˜ç¡®ï¼Œæ˜“äºç»´æŠ¤ï¼š

```
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚            Gradio WebUI              â”‚  â† User Interface Layer
               â”‚         (gradio_chat.py)             â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚       TerminalAPIClient              â”‚  â† **Main API Interface**
               â”‚    (terminal_api_client.py)          â”‚
               â”‚   - Component coordination           â”‚
               â”‚   - Unified external interface       â”‚
               â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”˜
      Request Flow   â”‚                          â”‚   Response Flow
                     â”‚                          â”‚
   execute_command() â”‚                          â”‚ Process results
               â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â””â”€â”€â”€â”€â”€â”
               â”‚  Command      â”‚      â”‚  Output       â”‚  â† **Component Layer**
               â”‚  Executor     â”‚      â”‚ Processor     â”‚
               â”‚               â”‚      â”‚               â”‚
               â”‚ Cmd lifecycle â”‚      â”‚ Data cleaning â”‚
               â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”˜
   send_command()    â”‚                          â”‚ raw_output
               â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â””â”€â”€â”€â”€â”€â”
               â”‚               Connection             â”‚
               â”‚                 Manager              â”‚  â† **Connection Layer**
               â”‚         Connection lifecycle         â”‚
               â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”˜
   WebSocket comm    â”‚                          â”‚ Message receive
               â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â””â”€â”€â”€â”€â”€â”
               â”‚                WebSocket             â”‚  â† **Communication Layer**
               â”‚                  Client              â”‚
               â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”˜
                     â”‚                          â”‚
               â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â””â”€â”€â”€â”€â”€â”
               â”‚                 ttyd                 â”‚  â† **Terminal Server**
               â”‚      (WebSocket Terminal Server)     â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### **æ¥å£å±‚**
- **`TerminalAPIClient`** - ä¸»è¦APIæ¥å£ï¼Œè´Ÿè´£ç»„ä»¶åè°ƒå’ŒçŠ¶æ€ç®¡ç†

#### **ç»„ä»¶å±‚**  
- **`CommandExecutor`** - å‘½ä»¤æ‰§è¡Œå™¨ï¼Œä¸“æ³¨å‘½ä»¤ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆå‘é€ã€æ£€æµ‹å®Œæˆã€æ”¶é›†åŸå§‹ç»“æœï¼‰
- **`OutputProcessor`** - è¾“å‡ºå¤„ç†å™¨ï¼Œä¸“æ³¨æ•°æ®è½¬æ¢ï¼ˆæ¸…ç†æ§åˆ¶åºåˆ—ã€ç§»é™¤å›æ˜¾ï¼‰
- **`ConnectionManager`** - è¿æ¥ç®¡ç†å™¨ï¼Œç®¡ç†WebSocketè¿æ¥ç”Ÿå‘½å‘¨æœŸ

#### **é€šä¿¡å±‚**
- **`WebSocketClient`** - WebSocketé€šä¿¡å·¥å…·ï¼Œå¤„ç†åº•å±‚åè®®
- **`QCLIStateDetector`** - Q CLIçŠ¶æ€æ£€æµ‹å™¨ï¼ˆå¯é€‰ï¼‰

### æ•°æ®æµ

```
åŸå§‹æ•°æ® â†’ CommandExecutor (å®Œæˆæ£€æµ‹) â†’ OutputProcessor (æ¸…ç†) â†’ ç”¨æˆ·
```

**è®¾è®¡åŸåˆ™ï¼š**
- âœ… **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªç»„ä»¶åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„åŠŸèƒ½
- âœ… **æ¸…æ™°è¾¹ç•Œ**ï¼šç»„ä»¶é—´æ¥å£ç®€å•æ˜ç¡®
- âœ… **å•å‘æ•°æ®æµ**ï¼šé¿å…å¾ªç¯ä¾èµ–å’Œé‡å¤å¤„ç†

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨ TTYD æœåŠ¡

```bash
# å¯åŠ¨é»˜è®¤æœåŠ¡ (bash:7681)
./ttyd/ttyd-service.sh start

# å¯åŠ¨ä¸åŒç±»å‹çš„ç»ˆç«¯
./ttyd/ttyd-service.sh start python 7682    # Python REPL
./ttyd/ttyd-service.sh start qcli 8081      # Q CLI (å¦‚æœå·²å®‰è£…)
```

### 2. è®¿é—® Web ç»ˆç«¯

**æ–¹å¼ä¸€ï¼šGradio ChatInterface WebUIï¼ˆæ¨èï¼‰**
```bash
# å¯åŠ¨GradioèŠå¤©ç•Œé¢
./start-webui.sh
```
è®¿é—®åœ°å€: http://localhost:7860

ç‰¹æ€§ï¼š
- ğŸ¤– æ™ºèƒ½èŠå¤©ç•Œé¢ï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€å‘½ä»¤æ‰§è¡Œ
- ğŸ“ Markdownæ ¼å¼è¾“å‡ºï¼Œæ¸…æ™°æ˜“è¯»
- ğŸ”„ å®æ—¶æµå¼è¾“å‡ºå¤„ç†
- ğŸ’¬ å‘½ä»¤å†å²å’Œä¸Šä¸‹æ–‡ç»´æŠ¤
- ğŸ¨ ç°ä»£åŒ–UIè®¾è®¡

**æ–¹å¼äºŒï¼šQ CLI äº¤äº’æ¼”ç¤º**
```bash
# å¯åŠ¨ Q CLI äº¤äº’æ¼”ç¤ºï¼ˆå¿«é€Ÿå¯åŠ¨ï¼‰
uv run python qcli_interactive_demo.py
```

ç‰¹æ€§ï¼š
- ğŸš€ **å¿«é€Ÿå¯åŠ¨**: é€šè¿‡ tmux ä¼šè¯å…±äº«ï¼Œ5ç§’è¿æ¥ vs 30+ç§’é‡æ–°åˆå§‹åŒ–
- ğŸ’¬ **äº¤äº’å¼å¯¹è¯**: ç›´æ¥ä¸ Q CLI å¯¹è¯
- ğŸ“Š **ä¼šè¯ä¿¡æ¯**: æŸ¥çœ‹è¿æ¥çŠ¶æ€å’Œä¼šè¯ä¿¡æ¯

**æ–¹å¼ä¸‰ï¼šåŸç”ŸTTYD Webç»ˆç«¯**
æ‰“å¼€æµè§ˆå™¨è®¿é—®: http://localhost:7681

é»˜è®¤è®¤è¯ä¿¡æ¯:
- ç”¨æˆ·å: demo
- å¯†ç : password123

### 3. API ä½¿ç”¨ç¤ºä¾‹

```python
import asyncio
from api import TerminalAPIClient

async def example():
    # ä½¿ç”¨å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨
    async with TerminalAPIClient(
        host="localhost", 
        port=7681, 
        username="demo", 
        password="password123"
    ) as client:
        
        # æ‰§è¡Œå‘½ä»¤
        result = await client.execute_command('ls -la')
        
        print(f"æˆåŠŸ: {result.success}")
        print(f"é€€å‡ºç : {result.exit_code}")
        print(f"æ‰§è¡Œæ—¶é—´: {result.execution_time:.2f}ç§’")
        print("æ¸…ç†åè¾“å‡º:")
        print(result.formatted_output)

# è¿è¡Œç¤ºä¾‹
asyncio.run(example())
```

## ğŸ”§ æœåŠ¡ç®¡ç†

### TTYD æœåŠ¡è„šæœ¬

`ttyd/ttyd-service.sh` æä¾›å®Œæ•´çš„æœåŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š

```bash
# åŸºæœ¬å‘½ä»¤
./ttyd/ttyd-service.sh start [type] [port]  # å¯åŠ¨æœåŠ¡
./ttyd/ttyd-service.sh stop [type] [port]   # åœæ­¢æœåŠ¡
./ttyd/ttyd-service.sh restart [type] [port] # é‡å¯æœåŠ¡
./ttyd/ttyd-service.sh status [type] [port] # æŸ¥çœ‹çŠ¶æ€
./ttyd/ttyd-service.sh stop-all             # åœæ­¢æ‰€æœ‰æœåŠ¡
./ttyd/ttyd-service.sh help                 # æ˜¾ç¤ºå¸®åŠ©

# ç¤ºä¾‹
./ttyd/ttyd-service.sh start               # å¯åŠ¨é»˜è®¤æœåŠ¡ (bash:7681)
./ttyd/ttyd-service.sh start python 7682   # å¯åŠ¨PythonæœåŠ¡ (ç«¯å£7682)
./ttyd/ttyd-service.sh status              # æŸ¥çœ‹é»˜è®¤æœåŠ¡çŠ¶æ€
```

### æ”¯æŒçš„ç»ˆç«¯ç±»å‹

- `bash` - Bash Shell (é»˜è®¤)
- `python` - Python REPL
- `qcli` - Q CLI (éœ€è¦å…ˆå®‰è£… Q CLI)

### é…ç½®æ–‡ä»¶

`ttyd/conf.ini` æ”¯æŒå®Œæ•´çš„é…ç½®ç®¡ç†ã€‚

## ğŸ¨ æ ¼å¼åŒ–è¾“å‡ºç‰¹æ€§

é¡¹ç›®çš„ä¸€å¤§ç‰¹è‰²æ˜¯æ™ºèƒ½çš„è¾“å‡ºæ ¼å¼åŒ–ï¼Œå°†åŸå§‹ç»ˆç«¯è¾“å‡ºè½¬æ¢ä¸ºå‹å¥½çš„Markdownæ ¼å¼ï¼š

### è¾“å‡ºæ¸…ç†

- **ANSIåºåˆ—æ¸…ç†**: ç§»é™¤é¢œè‰²å’Œæ ¼å¼æ§åˆ¶å­—ç¬¦
- **OSCåºåˆ—æ¸…ç†**: ç§»é™¤ç°ä»£shellçš„é›†æˆä¿¡æ¯
- **æç¤ºç¬¦æ¸…ç†**: ç§»é™¤å‘½ä»¤æç¤ºç¬¦æ®‹ç•™
- **ç©ºç™½å¤„ç†**: æ™ºèƒ½å¤„ç†å¤šä½™çš„ç©ºç™½å’Œæ¢è¡Œ

### Markdownæ ¼å¼åŒ–

```markdown
## âœ… å‘½ä»¤æ‰§è¡Œ - æˆåŠŸ
**å‘½ä»¤:** `ls -la`
**æ‰§è¡Œæ—¶é—´:** 0.01ç§’
**è¾“å‡º:**
```bash
total 392
drwxrwxr-x 15 ubuntu ubuntu  6144 Aug  1 09:49 .
drwxrwxr-x 12 ubuntu ubuntu  6144 Jul 30 11:35 ..
-rw-rw-r--  1 ubuntu ubuntu  8624 Aug  1 09:43 README.md
```
---
```

## ğŸ§ª æµ‹è¯•

### è¿è¡Œæµ‹è¯•

```bash
# é›†æˆæµ‹è¯•ï¼ˆéœ€è¦TTYDæœåŠ¡è¿è¡Œï¼‰
uv run python tests/test_terminal_api_integration.py

# æœåŠ¡è„šæœ¬æµ‹è¯•
uv run python tests/test_ttyd_service.py

# æ ¼å¼åŒ–è¾“å‡ºæµ‹è¯•
uv run python tests/test_formatted_output.py

# ä½¿ç”¨pytestè¿è¡Œæ‰€æœ‰æµ‹è¯•
uv run python -m pytest tests/ -v
```

### æµ‹è¯•è¦†ç›–

- âœ… WebSocketè¿æ¥å’Œè®¤è¯
- âœ… å‘½ä»¤æ‰§è¡Œå’Œè¾“å‡ºå¤„ç†
- âœ… æ ¼å¼åŒ–å’Œæ¸…ç†åŠŸèƒ½
- âœ… æœåŠ¡ç®¡ç†è„šæœ¬
- âœ… é”™è¯¯å¤„ç†å’Œæ¢å¤

## ğŸ”’ å®‰å…¨è€ƒè™‘

### å½“å‰å®‰å…¨æªæ–½

- **HTTPåŸºæœ¬è®¤è¯**: ç”¨æˆ·åå¯†ç éªŒè¯
- **è¿æ¥æ•°é™åˆ¶**: é˜²æ­¢èµ„æºè€—å°½
- **å‘½ä»¤æƒé™**: åŸºäºå¯åŠ¨ç”¨æˆ·çš„æƒé™
- **è¾“å…¥éªŒè¯**: é˜²æ­¢æ¶æ„è¾“å…¥

### ç”Ÿäº§ç¯å¢ƒå»ºè®®

1. **ä½¿ç”¨HTTPS/WSS**
   ```bash
   # åœ¨conf.iniä¸­é…ç½®SSL
   ssl=true
   ssl_cert="/path/to/cert.pem"
   ssl_key="/path/to/key.pem"
   ```

2. **å¼ºåŒ–è®¤è¯**
   - ä½¿ç”¨å¼ºå¯†ç 
   - å®šæœŸæ›´æ¢å‡­æ®
   - è€ƒè™‘é›†æˆå¤–éƒ¨è®¤è¯ç³»ç»Ÿ

3. **ç½‘ç»œå®‰å…¨**
   - ä½¿ç”¨é˜²ç«å¢™é™åˆ¶è®¿é—®
   - é…ç½®åå‘ä»£ç†
   - å¯ç”¨è®¿é—®æ—¥å¿—

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥æœåŠ¡çŠ¶æ€
   ./ttyd/ttyd-service.sh status
   
   # æŸ¥çœ‹æ—¥å¿—
   tail -f logs/ttyd-bash-7681.log
   ```

2. **è®¤è¯é—®é¢˜**
   - ç¡®è®¤conf.iniä¸­çš„credentialé…ç½®
   - æ£€æŸ¥ç”¨æˆ·åå¯†ç æ ¼å¼

3. **è¾“å‡ºæ ¼å¼é—®é¢˜**
   - æ£€æŸ¥format_outputå‚æ•°æ˜¯å¦å¯ç”¨
   - æŸ¥çœ‹utils.pyä¸­çš„æ¸…ç†è§„åˆ™

### è°ƒè¯•æŠ€å·§

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
# åœ¨conf.iniä¸­è®¾ç½®: debug_level=7

# æ‰‹åŠ¨æµ‹è¯•è¿æ¥
curl -u demo:password123 http://localhost:7681/ -I

# æ£€æŸ¥WebSocketè¿æ¥
# ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹WebSocketæµé‡
```

## ğŸš€ æ‰©å±•å’Œå®šåˆ¶

### æ·»åŠ æ–°çš„ç»ˆç«¯ç±»å‹

1. åœ¨`conf.ini`ä¸­æ·»åŠ å‘½ä»¤é…ç½®:
   ```ini
   nodejs_command="node"
   ```

2. åœ¨`ttyd-service.sh`çš„`get_terminal_command`å‡½æ•°ä¸­æ·»åŠ å¤„ç†:
   ```bash
   "nodejs")
       echo "$(get_config nodejs_command)"
       ;;
   ```

### è‡ªå®šä¹‰æ ¼å¼åŒ–è§„åˆ™

ä¿®æ”¹`api/utils.py`ä¸­çš„`TerminalOutputFormatter`ç±»:

```python
def _looks_like_code_output(self, text: str) -> bool:
    # æ·»åŠ è‡ªå®šä¹‰çš„ä»£ç è¾“å‡ºæ£€æµ‹è§„åˆ™
    custom_indicators = ['your_pattern']
    return any(indicator in text for indicator in custom_indicators)
```

## ğŸ“š å¼€å‘æ–‡æ¡£

- [é¡¹ç›®æ¶æ„æ–‡æ¡£](docs/) - è¯¦ç»†çš„æŠ€æœ¯æ–‡æ¡£
- [TTYDåè®®å¼€å‘æŒ‡å—](docs/ttyd-protocol-dev-guide.md) - é€šç”¨çš„ttydå¼€å‘ç»éªŒå’ŒæŠ€å·§

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

### å¼€å‘ç¯å¢ƒè®¾ç½®

```bash
# å®‰è£…ä¾èµ–
uv sync

# è¿è¡Œæµ‹è¯•
uv run python -m pytest

# å¯åŠ¨å¼€å‘æœåŠ¡
./ttyd/ttyd-service.sh start
```

## ğŸ“ è®¸å¯è¯

MIT License

---

**æ³¨æ„**: æœ¬é¡¹ç›®ä¸“æ³¨äºæ¼”ç¤ºTTYDçš„Webç»ˆç«¯APIåŠŸèƒ½ï¼Œé€‚åˆå­¦ä¹ å’ŒåŸå‹å¼€å‘ã€‚ç”Ÿäº§ç¯å¢ƒä½¿ç”¨è¯·æ³¨æ„å®‰å…¨é…ç½®ã€‚
